name: Deploy to shinyapps.io

on:
  push:
    branches: [ main ]
    paths:
      - "app.R"
      - "data/**"
      - "renv.lock"
      - "renv/activate.R"
      - ".Rprofile"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

concurrency:
  group: shinyapps-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    # TIP: pin to 22.04 to get more prebuilt binaries.
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system libraries for rsconnect/curl
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev libssl-dev

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Deploy to shinyapps.io
        env:
          SHINYAPPS_NAME:   ${{ secrets.SHINYAPPS_NAME }}
          SHINYAPPS_TOKEN:  ${{ secrets.SHINYAPPS_TOKEN }}
          SHINYAPPS_SECRET: ${{ secrets.SHINYAPPS_SECRET }}
        run: |
          Rscript - <<'RS'
          repos <- "https://cloud.r-project.org"
          # install deps explicitly to avoid partial failures
          for (pkg in c("curl","openssl","jsonlite","snowflakeauth","rsconnect")) {
            if (!requireNamespace(pkg, quietly = TRUE)) install.packages(pkg, repos = repos)
          }

          rsconnect::setAccountInfo(
            name   = Sys.getenv("SHINYAPPS_NAME"),
            token  = Sys.getenv("SHINYAPPS_TOKEN"),
            secret = Sys.getenv("SHINYAPPS_SECRET")
          )

          rsconnect::deployApp(
            appName  = "FeuxSaguenay2023",
            appFiles = c("app.R","data","renv.lock","renv/activate.R",".Rprofile"),
            logLevel = "normal"
          )
          RS
